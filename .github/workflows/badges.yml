name: Badges

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
  pull_request:
    paths:
      - '**.py'
      - '.github/**'
      - 'requirements.txt'

env:
  DEFAULT_PYTHON: "3.13"

jobs:
  generate:
    name: Generate badge files
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v5.0.0

    - name: Setup uv
      uses: astral-sh/setup-uv@v6.6.0

    - name: Setup Python ${{ env.DEFAULT_PYTHON }}
      uses: actions/setup-python@v5.6.0
      with:
        python-version: ${{ env.DEFAULT_PYTHON }}

    - name: Install Python dependencies
      run: |
        uv pip install --system -r requirements.txt

    - name: Get and save data
      shell: bash
      run: |
        uv run python script/custom_integration_badges.py

    - name: Read changes summary
      id: changes
      run: |
        if [ -f "badge_changes_summary.json" ]; then
          echo "summary=$(cat badge_changes_summary.json | jq -c .)" >> $GITHUB_OUTPUT
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request
      id: cpr
      if: steps.changes.outputs.has_changes == 'true'
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        author: "ha-analytics-bot <ha-analytics-bot@users.noreply.github.com>"
        committer: "ha-analytics-bot <ha-analytics-bot@users.noreply.github.com>"
        title: "ü§ñ Update badges"
        branch: "update-badges"
        base: main
        body: |
          ## ü§ñ Automated badge update
          
          This PR is automatically generated to update integration badges with the latest data.
          
          ### Summary
          - **Total files changed**: ${{ fromJson(steps.changes.outputs.summary).total_changes }}
          - **Added**: ${{ fromJson(steps.changes.outputs.summary).added | length }} files
          - **Modified**: ${{ fromJson(steps.changes.outputs.summary).modified | length }} files  
          - **Removed**: ${{ fromJson(steps.changes.outputs.summary).removed | length }} files
          
          <details>
          <summary>üìÑ Detailed file changes</summary>
          
          **Added files:**
          ${{ fromJson(steps.changes.outputs.summary).added | join('\n- ') }}
          
          **Modified files:**
          ${{ fromJson(steps.changes.outputs.summary).modified | join('\n- ') }}
          
          **Removed files:**  
          ${{ fromJson(steps.changes.outputs.summary).removed | join('\n- ') }}
          </details>
          
          This PR will be automatically merged if all checks pass.
        commit-message: "ü§ñ Autoupdate badges"
        delete-branch: true
        labels: |
          data-update
          automated

    - name: Comment on source PR
      if: github.event_name == 'pull_request' && steps.cpr.outputs.pull-request-operation == 'created'
      uses: actions/github-script@v7
      with:
        script: |
          const summary = JSON.parse('${{ steps.changes.outputs.summary }}');
          
          const commentBody = `## ü§ñ Badge Update Triggered
          
          This PR has triggered an automatic badge update. 
          
          **Files affected:**
          - **Added**: ${summary.added.length} files
          - **Modified**: ${summary.modified.length} files
          - **Removed**: ${summary.removed.length} files
          
          üìù **Badge update PR**: #${{ steps.cpr.outputs.pull-request-number }}
          
          The badge files will be updated automatically and merged if all checks pass.`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
          });

    - run: sleep 5
      if: steps.cpr.outputs.pull-request-operation == 'created'

    - name: Enable Pull Request Automerge
      if: steps.cpr.outputs.pull-request-operation == 'created'
      uses: peter-evans/enable-pull-request-automerge@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
        merge-method: squash

    - name: Add PR status comment
      if: steps.cpr.outputs.pull-request-operation == 'created'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: ${{ steps.cpr.outputs.pull-request-number }},
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `‚úÖ **Automerge enabled** - This PR will be automatically merged when all status checks pass.
            
            üîç **Transparency note**: This automation ensures badge data stays current with minimal manual intervention while maintaining full visibility of all changes.`
          });

    - name: Cleanup
      if: always()
      run: |
        rm -f badge_changes_summary.json
